攻撃の概要
ホストベース
システム/ホストベースの攻撃
・システム/ホストベースの攻撃とは、特定のOSを実行している特定のシステムやホストを標的にする攻撃。
・ネットワークサービス以外にもペンテスで狙う攻撃ベクトルになる。
・システム/ホストベースの攻撃は通常、ターゲットのネットワークにアクセスを得た後に用いる。
・システム/ホストベースの攻撃は、主にターゲットOSに内在する脆弱性を悪用することに焦点を当てている。
・システム/ホストベースの攻撃は、ネットワーク攻撃よりも専門的で、ターゲットのOSとそれへの影響を理解する必要がある。
・システム/ホストベースの攻撃は、ターゲットOS内の設定ミスや内在する脆弱性を悪用することを含む

windows
windowsの脆弱性
windowsの脆弱性の悪用
・windowsの脆弱性の種類
1) 情報開示：機密データへ攻撃者がアクセスできてしまう脆弱性
2) バッファーオーバーフロー：プログラミングの誤りによりバッファーに過剰なデータを書き込み、割り当てられたメモリアドレスを上書きしてしまう脆弱性
3) リモートコードの実行：攻撃者がターゲット上でリモートに任意のコードを実行できてしまう
4) 権限昇格：初期侵入後に攻撃者がより高い権限を取得できてしまう脆弱性
5) サービス拒否：攻撃者がシステムのリソースを枯渇させ、正常な動作を妨げる脆弱性

Metasploitを使用したwebdavのエクスプロイト
demo

PsExecを使ったSMBのエクスプロイト
・SMB(Server Message Block)は、ローカルネットワーク上のコンピュータ間でファイルや周辺機器を共有するために使用されるネットワーク共有プロトコル
→SMBはポート445
・SAMBAは、SMBのオープンソース実装で、WindowsシステムがLinuxの共有やデバイスにアクセスできるようにする。

・SMBプロトコルでは、2段階で認証を行う
1) ユーザー認証：ユーザーは共有にアクセスするために、SMBサーバーへ認証するときにユーザー名とパスコードを提供する必要がある
2) 共有認証：制限付きの共有にアクセスするために、ユーザーはパスワードを提供する

・PsExecは、Microsoftが開発した軽量のtelnetの代替ツールで、任意のユーザ資格情報を使ってリモートwindowsシステム上でプロセスを実行できる。
→PsExecの認証は、SMB経由で行う
→PsExecユーティリティを使うとターゲットシステムに正当な資格情報で認証して任意のコマンドを実行したり、、リモートのコマンドプロンプトを起動したりする
→RDPに似ているが、GUIでリモート操作する代わりにCMD経由でプロセスを実行するという点が異なる

・PsExecを利用してWindowsのターゲットにアクセスするためには、正当なユーザアカウントとそのパスコードまたはパスワードハッシュを特定する必要がある
・これはさまざまな手法を利用できるが、最も一般的なのは、ブルートフォース攻撃である
・ブルートフォースの対象は、一般的なwindowsユーザアカウントのみに絞る
・資格情報を得た後、それを使ってPsExec経由でターゲットに認証し、任意のシステムコマンドを実行したりリバースシェルを取得したりすることが可能。

windows ms17-010 smb脆弱性
demo

RDP exploit
・RDPは、Microsoftが開発した独自のGUIリモートアクセスプロトコルで、windowsシステムにリモート接続して操作するために使用される
・RDPはデフォで、3389を使用するが、設定で変更可能
・RDPの認証には、ターゲットシステム上の正当なユーザアカウントと、そのユーザーのパスコードが必要
・RDPに対してブルートフォースを行うことで、ユーザーの認証情報を得れる。

demo
1) 

winRM exploit
・Windows Remote Managementは、windowsのリモート管理プロトコルでHTTPSを使ってWindowsシステムへのリモートアクセスを容易にするために利用できる
・Microsoftは、winrmをwindowsに実装した。
・winrmの用途は以下のようになる
1) ローカルネットワーク上のwindowsホストにリモートでアクセスしてやり取りする。
2) windowsシステムにリモートでアクセスしてコマンドを実行する
3) windowsシステムを遠隔で管理・設定する。
・winrmは通常TCPポート5985(HTTP)および5986(HHTTPS)を使用する

・winrmは、さまざまな認証方式を通じてシステム間の通信に対するアクセス制御とセキュリティを実装
・「crackmapexec」というユーティリティを使ってwinrmに対してブルートフォースを実行し、ユーザ名とパスコードを特定し、ターゲット上で実行する
・rubyスクリプトの「evil-winrm」を利用して、ターゲットシステム上でコマンドシェルセッションを取得できる


windowsの権限昇格
・権限昇格とは、システム内の脆弱性や設定ミスを悪用し、あるユーザから別なユーザへ権限を引き上げるプロセスのこと
・権限昇格は、攻撃ライフサイクルで極めて重要な要素であり、ペンテスト全体の成功を左右する主要な要因
・ターゲットシステムへの足がかりを手に入れた後に、管理者権限が必要なタスクや機能を実行するために権限を昇格させる必要がある。

・カーネルとは、OSの中核となるプログラムで、システム上のあらゆるリソースやハードウェアを完全に制御する。
→ハードウェアとソフトウェアの通信を仲介する。
・カーネルは、主に以下の二つの動作モードからなり、これらがシステムリソースやハードウェアへのアクセスを決定する。
1) ユーザモード：ユーザモードで動作するプログラムやサービスは、システムリソースや機能へのアクセスが制限される。
2) カーネルモード：カーネルモードはデバイス管理やシステムメモリの管理などを含み、システムリソースや機能への無制限のアクセス権を持つ

・windows上でのカーネル悪用は、通常windowsカーネル内の脆弱性を標的とし、任意のコードを実行することで特権システムコマンドを動かすまたはシステムシェルを取得するために行う。
・このプロセスはターゲットなるWindowsのバージョンや使用するカーネル悪用の種類によって異なる
・Windowsシステム上での権限昇格は通常以下の手順で行う
1) カーネルの脆弱性の特定
2) カーネルエクスプロイトをダウンロード・コンパイルし、ターゲットシステムに転送する。


UACMeでUACをバイパスする
・User account control(UAC)は、windows vistaで導入されたWindowsのセキュリティ機能で、OSに対する不正な変更を防止するために使用される。
・UACは、OSへの変更が管理者またはローカル管理者グループに属するユーザーアカウントの承認を必要とすることを保証するために使用
・管理者権限が必要なプログラムを実行しようとする非特権ユーザは、UACの認証入力が必要。
管理者の場合は、確認プロンプトが表示される
・攻撃者は、昇格された権限で悪意のある実行ファイルを実行するためにUACをバイパスすることがある。

・UACを正常にバイパスするためには、ターゲットのwindowsシステム上でローカル管理者グループに属するユーザアカウントへのアクセスが必要
・UACは、管理者権限でプログラムを実行できる仕組みであり、その際にユーザーに確認プロンプトを表示する。
・UACには、複数の整合性レベルがあり、低から高まで設定可能で、保護レベルが「高」より低く設定されている場合、
Windowsプログラムは認証プロンプトなしで昇格権限を持って実行されることがある。
・UACをバイパスするために使われるツールや手法は複数存在する。
ただし、使用するツールや手法はターゲットwindowsバージョンによって異なる。


アクセストークンのなりすまし
・Windowsアクセストークンは、Windowsにおける認証プロセスの中核的な要素であり、ローカルセキュリティ機関サブシステムサービスによって作成・管理される。
・Windowsアクセストークンは、システム上で動作するプロセスやスレッドのセキュリティコンテキストを識別・記述する役割を持つ
→アクセストークンは一時的なキーのようなもので、webのクッキーに似た仕組み
・アクセストークンは、ユーザが認証に成功するたびに、winlogon.exeプロセスによって生成される
→このトークンには、スレッドやプロセスに関連するユーザアカウントの識別情報と権限情報が含まれる
　その後、このトークンはuserinit.exeプロセスにアタッチされて、ユーザによって開始された全ての子プロセスは、生成元からアクセストークンのコピーを継承し、同じアクセストークンの権限下で実行される。

・windowsアクセストークンは、それぞれに割り当てられたさまざまなセキュリティレベルに基づいて分類される。これらのセキュリティレベルは、特定のトークンにどの権限が割り当てられるかを決定するために使用する。
・アクセストークンは通常、以下のいずれかのセキュリティレベルが割り当てられる。
1) impersonateレベルのトークン：windows上での非対話ログオンの直接的な結果として作成される
→ローカルシステム上でトークンの成り替わりに利用できるが、そのトークンを利用する外部システム上では成り変われない
2) delegateレベルのトークン：通常は対話的ログオンによって作成される
→任意のシステム上でトークンの成り替わりができるため脅威

quiz
・アクセストークンを偽装するには、「selmersonateprivilege」権限を持つアカウントにアクセスできる必要がある
・ユーザ権限の列挙に使用できるのは、getprivs

