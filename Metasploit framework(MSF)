Metasploit
Metasploit frameworkの概要
Metasploit frameworkの紹介
・MSFは、オープンソースの堅牢なペンテスおよび脆弱性攻撃のフレームワークで、世界中のペンテスターやセキュリティ研究所で使っている。
・MSFは、ペンテストのライフサイクルのあらゆる段階を自動化するために必要な堅牢なインフラをテスターに提供する
・そして、exploitの開発およびテストも行なっており、世界最大級の公開・検証済みエクスプロイトデータベースを持っている。
・MSFでは、モジュール式の設計なので、新しい機能を容易に実装可能

・MSFのソースコードは、Githubで入手可能
・開発者たちは、常に新しいエクスプロイトをフレームワークに追加している。

・以下は重要な用語である
1) インターフェース：msfとやりとりするための方法
2) モジュール：特定のタスクを実行するためのコードの断片
3) 脆弱性：攻撃者に悪用され得るコンピュータ内やネットワーク内の弱点または欠陥
4) エクスプロイト：システム、サービス、アプリケーション内の脆弱性を悪用するためのコードやモジュール
5) ペイロード：エクスプロイトによってターゲットシステムに送られるコード
6) リスナー：ターゲットからの接続を待ち受けるプログラム
7) ライブラリ：複数のプログラムが共通して使える機能をまとめたコードの集まり

・msfが正式に公開されたのは、2003年

MSFのアーキテクチャー
・MSFの全体像

・MSFモジュールには以下のものがある
1) エクスプロイト：脆弱性を利用するためのモジュールでペイロードと組み合わせて使う
2) ペイロード：エクスプロイト成功後にMSFがターゲットに送り、リモートで実行されるコード
3) エンコーダ：AV検出を回避するためにペイロードをエンコードするためのモジュール
4) NOPs：ペイロードのサイズを一定にし、実行時の安定性を保つために使われる
5) Auxiliary：ポートスキャンや列挙など、攻撃以外の追加機能を実行するモジュール

・ペイロードには以下の2種類がある。
1) Non-Staged Payload
・エクスプロイトとともにそのままターゲットに送られるペイロード
・ステージ分割せず、一塊で送って実行する
2) Staged Payload
・これはペイロードを2段階で送る方式
　最初の部分は、ターゲット上で攻撃者へ逆接続を確立するための小さなコードを含む
  リバース接続を確立すると、攻撃者側から残りの本体をダウンロードして実行する

・StageとStagersについて
1) Stage
・Stagerによってダウンロードされるペイロード本体の要素
2) Stager
・Stagerは通常、攻撃者とターゲットの間で安定した通信チャネルを確立するために使われ、その後、ターゲット上でステージペイロードがダウンロードされ実行される。

・Meterpreter payloadは、高度で多機能なペイロードで、ターゲット上のメモリ上で実行されるため検出が難しくなっている。
→MeterpreterはStagerのソケット経由で通信し、攻撃者に対してターゲット上で対話型のコマンドを提供
→これを使用すると、システムコマンドの実行、ファイルシステムの操作、キー入力の記録などの操作可能

・msfの開発には、Rupyが使用されている。

MSFを使用したペンテス
・MSFは、ペンテスのライフサイクルに含まれる様々なタスクを実行および自動化するために使用できる。

・ペネトレーションテスト実行基準(PTES)は、包括的で最新のペンテストの基準の必要性に対応することを目的に、書かれたペンテストの手法


Metasploitの基礎
MSFのインストールと設定
・MSFは、Rapid7によって配布されており、WindowsとLinuxの両方でスタンドアロンパッケージとしてダウンロードしてインストールできる。

・MSFDatabaseは、MSFの不可欠な部分であり、アセスメントやホストのスキャン結果などを追跡するために使われる
→MSFは主要なデータベースサーバーとしてPostgresqlを使用するためPostgresqlが正しく設定されているかを確認する必要がある
→MSFDBは、nmapやnessusといったサードパーティーツールからのスキャン結果やインポートの保存も容易になる

quiz
・MSFDBをセットアップおよび初期化するために使用できるコマンドは、sudo msfdb init

MSF consoleの基礎
・MSFconsoleは、MSFのすべての機能にアクセスできる、使いやすいオールインワンのインターフェース

・MSFモジュールは、通常、リモートのエクスプロイト/接続を開始するために、ターゲットやホストのIPアドレスやポートといった情報を必要とする。
→これらのオプションは、MSFの変数を使って設定できる。
→この変数は、グローバルでもローカルでもどちらでもいける

・MSF module 変数
変数            用途
LHOST　　　　　攻撃者側システムのIPアドレスを格納するための変数
LPORT　　　　　攻撃者側でリバース接続を受けるために使用するポート番号を格納するための変数
RHOST　　　　　ターゲットシステム/サーバーのIPアドレスを格納するための変数
RHOSTS　　　　 複数のターゲットIPやネットワークレンジを指定するための変数　
RPORT　　　　　ターゲット側で攻撃対象となるポート番号を格納する変数

quiz
・windowsと互換性のあるモジュールのみを表示するように結果を制限するために使用できるmsfconsoleは、search type:exploit platform：windows

情報収集と列挙
Nmap
Nmapによるポートスキャンと列挙
・Nmapは、ネットワーク上のホストを発見したり、対象のオープンポートをスキャンしたりするために使用できる無料かつオープンソースのネットワークスキャナー
・オープンポートで稼働しているサービスや対照システム上で動作しているOSを列挙もできる


・Nmapのスキャンのうち、スキャンの結果をXMLに出力するために使用できるのは、nmap -sV -O IPアドレス -oX output

・-sn：ポートスキャンは行わずに生存確認のみ行う
・-Pn：生存確認は行わずに、すべて生きていると仮定して、ポートスキャンのみを行う
・-sV:稼働しているサービスとバージョンを検出する
・-O：使用しているOSを検出する。
・-sS：TCP/SYNスキャンを実行する。

Nmapの結果をMSFにインポートする
・db_import：外部のnmapスキャンの結果をMSFDBにインポートできる
・host
・services
・db_nmap -Pn -sV -O IPアドレス
・vulns

列挙
補助モジュールによるポートスキャン
・補助モジュールは、スキャン、検出、ファジングなどの機能を実行するために使用する。
・補助モジュールを使って、TCP/UDPのポートスキャンを行ったり、FTP,SSH,HTTPなどのサービスから情報を列挙できる。
・補助モジュールは、exploitだけでなく、after exploitでも利用可能
・初期アクセスをターゲットシステムで取得した後に、別のネットワークサブネット上のホストを発見したりポートスキャンを行ったりするためにも補助モジュールを使用できる

・curl IPアドレス
・run autoroute -s IPアドレス
・sessions

FTP列挙
・FTPは、TCPポート21を使用するプロトコルで、サーバーとクライアント間でファイルの共有を行うために使用する
・FTPは、webサーバのディレクトリとの間でファイルを送受信する手段として頻繁に使用する
・複数の補助モジュールを使用して情報を列挙したり、ETPサーバーを実行しているターゲットに対してブルートフォース攻撃を実行できる。
・FTPの認証には、ユーザ名とパスコードの組み合わせだが、設定が不適切な場合は、匿名でログインできることもある。

